<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>UTC Smart Home Dashboard</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Th√™m NGAY SAU th·∫ª <body> trong index.html -->
    <script>
      console.log("üîç Checking authentication...");

      const token = localStorage.getItem("token");
      const userName = localStorage.getItem("userName");

      console.log("Token:", token ? "Found" : "Not found");
      console.log("UserName:", userName);

      if (!token) {
        console.log("‚ùå No token, redirecting to login...");
        window.location.href = "/login.html";
      } else {
        console.log("‚úÖ Token found, verifying...");

        // X√°c th·ª±c token
        fetch("/api/verify", {
          headers: { Authorization: "Bearer " + token },
        })
          .then((res) => {
            console.log("Verify response status:", res.status);
            return res.json();
          })
          .then((data) => {
            console.log("Verify response:", data);
            if (!data.success) {
              console.log("‚ùå Invalid token, clearing and redirecting...");
              localStorage.clear();
              window.location.href = "/login.html";
            } else {
              console.log("‚úÖ Token valid, user authenticated");
            }
          })
          .catch((err) => {
            console.error("Verify error:", err);
            localStorage.clear();
            window.location.href = "/login.html";
          });
      }
    </script>
    <script>
      // Ki·ªÉm tra ƒëƒÉng nh·∫≠p (s·ª≠ d·ª•ng t√™n bi·∫øn kh√°c ƒë·ªÉ tr√°nh redeclare)
      (function () {
        const existingToken = localStorage.getItem("token");
        if (!existingToken) {
          window.location.href = "/login.html";
          return;
        }

        // X√°c th·ª±c token
        fetch("/api/verify", {
          headers: { Authorization: "Bearer " + existingToken },
        })
          .then((res) => res.json())
          .then((data) => {
            if (!data.success) {
              localStorage.clear();
              window.location.href = "/login.html";
            }
          });

        // Hi·ªÉn th·ªã t√™n user (kh√¥ng d√πng c√πng t√™n bi·∫øn v·ªõi script kh√°c)
        const displayName = localStorage.getItem("userName");
        if (displayName) {
          document.querySelector(
            ".header-info h1"
          ).textContent = `Xin ch√†o, ${displayName}`;
        }
      })();
    </script>
    <script>
      async function logout() {
        console.log("üö™ Logging out...");
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) {
          const token = localStorage.getItem("token");

          // G·ªçi API logout ƒë·ªÉ blacklist token
          if (token) {
            try {
              await fetch("/api/logout", {
                method: "POST",
                headers: {
                  Authorization: "Bearer " + token,
                  "Content-Type": "application/json",
                },
              });
              console.log("‚úÖ Token invalidated on server");
            } catch (err) {
              console.error("Logout API error:", err);
            }
          }

          // Clear localStorage
          localStorage.clear();
          window.location.href = "/login.html";
        }
      }
    </script>

    <!-- Th√™m n√∫t Logout v√†o header -->
    <button
      onclick="logout()"
      style="
        padding: 8px 16px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      "
    >
      ƒêƒÉng xu·∫•t
    </button>

    <!-- Background Animation -->
    <div class="bg-animation">
      <div class="circle circle-1"></div>
      <div class="circle circle-2"></div>
      <div class="circle circle-3"></div>
    </div>

    <div class="container">
      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <div class="logo">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
              <rect width="40" height="40" rx="12" fill="url(#logo-gradient)" />
              <path d="M20 12L12 18V28H16V22H24V28H28V18L20 12Z" fill="white" />
              <defs>
                <linearGradient
                  id="logo-gradient"
                  x1="0"
                  y1="0"
                  x2="40"
                  y2="40"
                >
                  <stop stop-color="#667eea" />
                  <stop offset="1" stop-color="#764ba2" />
                </linearGradient>
              </defs>
            </svg>
          </div>
          <div class="header-info">
            <h1>UTC Smart Home</h1>
            <p class="subtitle">IoT Dashboard</p>
          </div>
        </div>
        <div class="header-right">
          <div id="connStatus" class="status-badge disconnected">
            <span class="status-dot"></span>
            <span class="status-text">ƒêang k·∫øt n·ªëi...</span>
          </div>
        </div>
      </header>

      <!-- Gas Warning Alert -->
      <div id="gasWarning" class="alert alert-danger hidden">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div class="alert-content">
          <div class="alert-title">C·∫£nh b√°o kh·∫©n c·∫•p!</div>
          <div class="alert-message">
            Ph√°t hi·ªán n·ªìng ƒë·ªô kh√≠ gas v∆∞·ª£t ng∆∞·ª°ng an to√†n
          </div>
        </div>
        <button
          class="alert-close"
          onclick="document.getElementById('gasWarning').classList.add('hidden')"
        >
          √ó
        </button>
      </div>

      <!-- Sensor Cards -->
      <section class="sensor-grid">
        <div class="sensor-card">
          <div class="sensor-header">
            <div class="sensor-icon temp-icon">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"
                />
              </svg>
            </div>
            <span class="sensor-label">Nhi·ªát ƒë·ªô</span>
          </div>
          <div id="temp" class="sensor-value">--</div>
          <div class="sensor-unit">¬∞C</div>
          <div class="sensor-bar">
            <div id="tempBar" class="sensor-progress" style="width: 0%"></div>
          </div>
        </div>

        <div class="sensor-card">
          <div class="sensor-header">
            <div class="sensor-icon humidity-icon">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" />
              </svg>
            </div>
            <span class="sensor-label">ƒê·ªô ·∫©m</span>
          </div>
          <div id="humidity" class="sensor-value">--</div>
          <div class="sensor-unit">%</div>
          <div class="sensor-bar">
            <div
              id="humidityBar"
              class="sensor-progress"
              style="width: 0%"
            ></div>
          </div>
        </div>

        <div class="sensor-card" id="gasSensor">
          <div class="sensor-header">
            <div class="sensor-icon gas-icon">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"
                />
                <path d="M8 12h8M12 8v8" />
              </svg>
            </div>
            <span class="sensor-label">Kh√≠ Gas</span>
          </div>
          <div id="gas" class="sensor-value">--</div>
          <div class="sensor-unit">ppm</div>
          <div class="sensor-bar">
            <div id="gasBar" class="sensor-progress" style="width: 0%"></div>
          </div>
        </div>
      </section>

      <!-- Device Controls -->
      <section class="device-grid">
        <!-- Light Control -->
        <div class="device-card">
          <div class="device-header">
            <div class="device-icon light-icon">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M9 18h6M10 22h4M15 2a7 7 0 0 1 0 14H9A7 7 0 0 1 9 2z"
                />
              </svg>
            </div>
            <div class="device-info">
              <h3>ƒê√®n ph√≤ng kh√°ch</h3>
              <span id="lightStatus" class="device-status">T·∫Øt</span>
            </div>
          </div>
          <div class="device-controls">
            <button id="btnLightOn" class="btn btn-on">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="9 11 12 14 22 4"></polyline>
                <path
                  d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"
                ></path>
              </svg>
              B·∫≠t
            </button>
            <button id="btnLightOff" class="btn btn-off">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
              </svg>
              T·∫Øt
            </button>
          </div>
        </div>

        <!-- Fan Control -->
        <div class="device-card">
          <div class="device-header">
            <div class="device-icon fan-icon">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"
                />
              </svg>
            </div>
            <div class="device-info">
              <h3>Qu·∫°t tr·∫ßn</h3>
              <span id="fanStatus" class="device-status">T·∫Øt</span>
            </div>
          </div>
          <div class="device-controls">
            <button id="btnFanOn" class="btn btn-on">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="9 11 12 14 22 4"></polyline>
                <path
                  d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"
                ></path>
              </svg>
              B·∫≠t
            </button>
            <button id="btnFanOff" class="btn btn-off">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
              </svg>
              T·∫Øt
            </button>
          </div>
        </div>

        <!-- Door Control -->
        <div class="device-card">
          <div class="device-header">
            <div class="device-icon door-icon">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <circle cx="8.5" cy="12.5" r="1.5" />
              </svg>
            </div>
            <div class="device-info">
              <h3>C·ª≠a ch√≠nh</h3>
              <span id="doorStatus" class="device-status">ƒê√≥ng</span>
            </div>
          </div>
          <div class="device-controls">
            <button id="btnDoorOpen" class="btn btn-door-open">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"
                ></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
              M·ªü
            </button>
            <button id="btnDoorClose" class="btn btn-door-close">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M21 2l-2 2m-7 7l-2 2M3 11l-1-1m0 6l8 8 1.5-1.5M15 7l3-3M6 11l9 9"
                />
              </svg>
              ƒê√≥ng
            </button>
          </div>
        </div>
      </section>

      <!-- Footer -->
      <footer class="footer">
        <div class="footer-left">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          <span id="lastUpdate">C·∫≠p nh·∫≠t: ‚Äî</span>
        </div>
        <div class="footer-right">
          <span>Powered by ESP32 & Node.js</span>
        </div>
      </footer>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="app.js"></script>
  </body>
</html>
